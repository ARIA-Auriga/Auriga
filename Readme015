----------------------------------------
//028 [2006/12/12] by Rayce

・武器修理についてeAを参考して修正（clif.c, skill.*）
	-> メニュー選択後に射程内に対象が居ない場合は失敗するように修正
	-> 成功したときのみエフェクトを出すように修正
	-> clif.cでは判定を行わず、全てskill_repair_weapon() 内で処理するように変更
	-> skill_can_repair() は skill_repair_weapon() に吸収したので削除
	-> 処理方法の改善

・向き判定用の配列 dirx[], diry[] をmap.cに集める（homun.c, map.*, pc.c, pet.c, skill.c, unit.c）
・unit_skillcastcancel() に詠唱妨害可能かどうかの判定を取り込む
　引数に2を指定すれば、関数内部でフェンカードやGvGマップかなどを調べます

----------------------------------------
//027 [2006/12/11] by Rayce

・conf/grf-files.txtでdata, sdata, adataの制限を取り払うように拡張（grfio.*, map.c）
	-> MAX_GRF_FILES（デフォルトでは10個）まで読み込み可能
	-> : の前の名前は15文字以内で任意に指定することができます
	　 同じ名前がある場合は下に記述されたもので上書きされます
	-> 行頭に // を入れるとコメントアウトとして扱われます
	-> map_athena.confの方はdata, sdata, adata固定のままです
	　 grf-files.txtを利用することを推奨します

----------------------------------------
//026 [2006/12/11] by Rayce

・db/produce_db.txtの拡張をAthena Projectの投稿分からmerge, thanks to Rohypnolさん（skill.*）
	-> dbに新しくFixPerの項目を挿入
	　 基本成功確率にこの値を加算することで確率の補正を個別に設定します
	-> skill_produce_db構造体から使われてないメンバ trigger を削除し、perを追加
	-> skill.hに製造グループ定数 PRD_*** を追加
	　 製造の種別はスキルIDではなくこのグループ定数で分類する
	-> battle_athena.confの以下3項目が全く利用されてなかったので修正
		scroll_produce_rate, making_rate, scroll_item_name_input
	-> クリエイトコンバーターは100%成功にしておく
	　 db/produce_db.txtのFixPerを10000に設定しただけで、計算式自体はskill.cに残してます
	-> オリデオコン/エルニウム作成は本鯖にはない機能なので、ItemLvを1003に変更しておく
	-> 説明についてはdoc/db_ref.txtに記載

・012のMAPコピー機能の追加以後、担当MAPを決める処理が誤作動を起こしそうな気がしたので少し修正（map.h）
・login.cから使われてない変数 m_start, gm_last を削除（login.c）

----------------------------------------
//025 [2006/12/09] by Rayce

・製造系の修正をAthena2262-fix4よりmerge、thanks to T.Nさん（clif.c, skill.*）
	-> skill_produce_mix() から確率計算部分を切り離して skill_calc_produce_rate() とする
	-> 同様にファーマシー成功時のランキング計算部分を切り離して skill_am_ranking_point() とする
	-> skill_can_produce_mix() はnameidではなくインデックスを直接受け取るように変更し、検索の無駄を省く
	-> トワイライトファーマシーで成功個数/ランキングを一度に獲得するように修正
	-> トワイライトファーマシー成功後、重量オーバーになってしまう場合は地面に落ちずに消滅するように

----------------------------------------
//024 [2006/12/08] by Rayce

・pc_dead() でのデスペナルティ処理を最適化（pc.c）
・カオティックベネディクションのスキルLvが11以上のときサーバクラッシュする問題を修正（skill.c）
・battle_athena.confでresurrection_expを設定していたとき、JobExpの計算が間違っていたバグを修正（skill.c）
・レデムプティオで取得できる経験値の計算において、battle_athena.confのdeath_penalty_typeの設定が
　正しく反映されてなかったバグを修正（skill.c）
・経験値計算処理は出来るだけdouble型ではなくatn_bignumber型を利用するように修正
・skill_castend_nodamage_id() を少し整形

----------------------------------------
//023 [2006/12/08] by Rayce

・setmapflag命令の機能拡張
	const.txtに記載されているマップフラグ全てをこの命令で設定できます。
	mf_nosave, mf_baseexp_rate, mf_jobexp_rate, mf_pvp_nightmaredrop, mf_gvg_nightmaredrop, mf_pk_nightmaredrop
	については更に引数を指定することで必要な情報を設定します。
・setmapflag命令でナイトメアモード用の設定を行うために npc_set_mapflag_sub() を利用するので
　staticを外してnpc.hで宣言するように変更
・setmapflagnosave命令は不要になったので抹消

・removemapflag命令の機能拡張
	ナイトメアモード系を削除する場合には該当マップのドロップリストを削除し、
	空き詰め処理を行います。

・checkmapflag関数の追加
	指定マップに該当のmapflagが設定されているかどうかを調べます。
	mf_baseexp_rate, mf_jobexp_rateの場合には設定した経験値取得倍率が返ってきます。
	ナイトメアモード系のドロップリストに関する情報は取得できません。

・上記を実装するに当たり、処理を一括でまとめたかったので変数にビットフィールドを使わないように変更
	全てint型にして、script_conv_mapflag() でアドレスを取得できるようにしています。
	base_exp_rateとjob_exp_rateをflag構造体のメンバとして取り込み。

　※checkmapflag関数はgetpkflag関数の上位互換版です。
　　if(getpkflag("this")) は if(checkmapflag("this",mf_pvp) || checkmapflag("this",mf_gvg))
　　と等価ということになります。。
　　マップフラグに応じてスクリプトの挙動やアイテムの効果を変化させたいときなどに。

----------------------------------------
//022 [2006/12/07] by Rayce

・mapflag関連の最適化や機能追加
　（atcommand.c, map.*, mob.c, npc.*, pc.c, script.c, skill.c）
	-> mapflagを設定する処理をまとめて npc_set_mapflag() を用意
	　 スクリプトからの読み込みと@mapflagからの読み込みで共用します
	-> base_exp_rateとjob_exp_rateで負の値を設定しても取得経験値倍率が0にならなかった問題を修正
	-> MF_***系定数をscript.cからmap.hへ移動
	-> map_data構造体内のdrop_list構造体に drop_flag メンバを追加
	　 Pv, Gv, PK でドロップリストを共存させるためのものです
	-> ナイトメアモードの場合のアイテムドロップ処理をまとめて pc_nightmare_drop() を用意
	　 処理がゴチャゴチャしてたので書き直し
	-> MAX_DROP_PER_MAP の値が大きすぎるので、48 → 8 に縮める
	　 越えてしまった場合は「drop list is full」が出力されます
	　 ナイトメアモードで多くのアイテムIDを設定したい場合にはこの値を大きくしてください
	-> PKフィールドをナイトメアモードに一括変更するとき（map_athena.confのmap_pk_nightmaredrop有効時）
	　 drop_listに空きがない場合はモード設定しないように変更
	-> 存在しないマップフラグをスクリプトに書いていた場合は警報が鳴るように
	-> 利用価値が低いので map_check_normalmap() を削除
	-> 以下の4つのマップフラグをスクリプトから設定できるように
		fireworks, cloud1, cloud2, cloud3
	-> ついでなので新しく gvg_nightmaredrop を追加
	　 シーズモードで且つアイテムをドロップする特殊なMAPを作ることができます
	-> db/const.txtを変更
	-> doc/script_ref.txt更新

・pc_damage() から死亡処理を切り離して pc_dead() を用意（pc.c）
・ALT+Gをしたときギルドエンブレムが時々表示されないバグを多分修正（clif.c）
	merged from eAthena, thx a lot!!

----------------------------------------
//021 [2006/12/06] by Rayce

・キャラIDは出来るだけsd->char_idではなくsd->status.char_idを参照するように修正
　sd->char_idは認証用に使うだけに留める
・スクリプト解析エンジンについてeAthenaより一部merge（script.c）

・doc/script_ref.txt更新
・db群の更新
	thanks to huge cgi

----------------------------------------
//020 [2006/12/06] by Rayce

・ブロックIDの定義が各ファイルに散らばってて把握しずらいのでmmo.hに集める
	-> MIN_FLOORITEM を追加、MAX_FLOORITEM をmap.hから移動
	-> START_ACCOUNT_NUM, END_ACCOUNT_NUM をlogin.hから移動
	-> START_NPC_NUM, END_NPC_NUM をnpc.hから移動

・clif_parse_WantToConnection() における不正パケットのチェックを強化（chrif.c, clif.c）
	-> 送られてきたアカウントIDが不正な値でないかチェックする
	　 （例えばIDの値がMAX_FLOORITEM以内だと、存在しているのに map_id2sd() で検索されないキャラが出来る）
	-> Sexの不正チェックを chrif_authreq() から移動
	-> session_dataをcallocする前に判定は行う、不正だった場合はタイムアウトで落とす
	-> 「invalid Account ID !!」および「invalid Sex !!」が出力された場合は、
	　 不正なアクセスが行われたことを意味します

・一部の weapontype1, weapontype2 変数への代入について、0を WT_FIST に置換（pc.c）
・map.cを少しだけ整形

・scriptのchangebase命令で、職業IDが22（ウェディング）および26（拳聖2）のときは武器を外す処理が含まれていたが
　この部分をコメントアウト（script.c）
	装備を外すとHPやSPが減少する効果（bSPPenaltyUnrig等）を持つ装備品を装備している状態（三葉蟲カード等）で、
	EquipScriptに changebase 22; が記述された装備品（ウェディングドレス等）を装備すると
	HPとSPが共に0になり死亡してしまう現象を修正するための処置です。
	武器を外す処理を省いてもウェディング状態のときは clif_changelook() で武器の表示をしないように処置される
	ためクライアントエラーにはなりません。

　※詳細
	上記の例の場合、呼び出される主な関数は以下の通り。
	pc_equipitem() → status_calc_pc() → run_script() → buildin_changebase() → pc_unequip() → pc_heal()
	bSPPenaltyUnrigの効果により装備の解除時に pc_heal() が呼ばれますが、status_calc_pc() ではmax_hpの値は
	まだ計算されていない状態なので max_hp = 0 です。
	従って pc_heal() で最初に呼ばれる pc_checkoverhp() によってHPが0にされてしまいます。

----------------------------------------
//019 [2006/12/05] by Rayce

・mob_dead() の処理改善および整形
・ホムがMVPを取ったときのMVP経験値に対しても battle_athena.conf の master_get_homun_base_exp
　の倍率を適用するように修正（mob.c）

・一部のスキルの倍率計算において、double型ではなくatn_bignumber型を使うように変更（battle.c）
　少しオーバーフローしやすくなってる可能性はあります…
・battle_calc_weapon_attack() で利用するマクロ名が紛らわしいので
　ATK_FIX → DMG_FIX, ATK_ADD → DMG_ADD に変更、新たに DMG_SET 追加（ダメージ値の置換用）

・atn_bignumber型の変換指定子を統一して使えるようにマクロ BIGNUMCODE を用意（mmo.h）
　基本的にprintf用で10進数のみ対応です。
　用意しただけで実際のコードには今のところ出現してませんが、数値をダンプしたいとき等に利用してください。
	printf("i = %"BIGNUMCODE, i);

----------------------------------------
//018 [2006/12/04] by Rayce

・被弾共闘が入らないのを修正（pc.c）
　応急処置的にbl.idで管理するようにはしてますが、本来ならPCの場合はキャラIDを利用すべきなので
　いずれ修正する必要はあります
	merged from Athena-2262, thanks to T.Nさん

・doc/script_ref.txtにおいてmapflagの base_exp_rate, job_exp_rate に関して追記
・一閃を必中に修正（battle.c）
・mob_damage() から死亡処理の部分を切り離して mob_dead() を用意、および少し整理（mob.c）
・mob_damage() にあるテコンミッションのターゲット選定でも無限ループに陥る可能性があったので修正（mob.c）

・経験値取得系の関数において、引数をint型からatn_bignumber型に変更
　および無駄なキャストを排除して整理し直し
	guild_payexp(), homun_gainexp(), party_exp_share(), pc_gainexp()
・ホムの取得経験値がオーバーフローする可能性を修正（homun.c）
・ホムが取得した経験値を主人へ渡すときの倍率をbattle_athena.confで指定できるように変更/拡張（battle.c, homun.c）
	master_get_homun_base_exp はデフォルトで100（%）です
	master_get_homun_job_exp  はデフォルトで0（%）です

----------------------------------------
//017 [2006/12/01] by Rayce

・battle_calc_weapon_attack() の修繕その８
	-> 回避判定を先に行い、回避できなかったときだけ必要なダメージ計算を行うように改善
	　 基本ダメージ計算 battle_calc_base_damage() などの処理が省略されますので、回避時の計算は
	　 かなり改善されているものと期待します
	-> ヒット・属性・レンジの補正は回避判定の前に集める
	　 これら3つの要素は最終ダメージ計算 battle_calc_damage() に必要です
	　 battle_calc_damage() は回避出来たときにも呼び出されるので、回避判定前に補正しておかなければなりません

　※クリティカル時の処理をさらに改善する余地はありますが、長らく続いた修繕関連はこれでひとまず終了とします。

----------------------------------------
//016 [2006/11/29] by Rayce

・ヒールと治療の助けをカイトで反射した際にもエフェクトを付ける（skill.c）
・ローグの魂効果中はディスペル無効に修正（skill.c）

・battle_calc_weapon_attack() の修繕その７
	-> 「カードによるダメージ追加処理」「カードによる左手ダメージ追加処理」「カードによるダメージ減衰処理」
	　 「対象にステータス異常がある場合のダメージ減算処理」の4項目は、ダメージがあるときだけ計算する
	　 これらはダメージ倍率を計算する部分ですが、ダメージが0の場合は積を取っても結局0になるのは確定しているので
	　 計算を行う必要はありません
	-> スパイラルピアースのスキル倍率が間違っていたので修正、break抜け？
	-> 細かい整形

----------------------------------------
//015 [2006/11/21] by Rayce

・サーバースナップショット（version.h）
・不要なファイルを削除
　　conf/
	help1.txt, help2.txt, help3.txt, help4.txt
　　src/common/
	zconf_win32.h, zlib_win32.h
