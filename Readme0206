----------------------------------------
//0262 [2007/07/30] by Rayce

・スキルIDからスキルツリー情報を取得する際の処理を高速化（homun.*, pc.*）
	homun_search_skilltree(), pc_search_skilltree() 追加。
	バイナリサーチを使って検索します。
	db/homun_skill_tree.txtおよびdb/skill_tree.txtがそれぞれスキルIDの昇順に並んで記述されている
	ことを前提としています。
	並んでいなくてもデータベース読み込み時に自動的に補正されますが、読み込み速度が低下する可能性が
	あるので出来るだけソート済みの状態にしておいてください。
	デフォルトのdbは全てソート済みなので問題はありません。

	例）143が142よりも前に記述されているのは推奨されない
		0,0,143,1,0,0,0,0,0,0,0,0,0,0,0,0,0//NV_TRICKDEAD	#死んだふり#
		0,0,142,1,0,0,0,0,0,0,0,0,0,0,0,0,0//NV_FIRSTAID	#応急手当#

・AthenaProject2307に合わせてscript/monster/etcをscript/monster/eventに変更
・npc_monster_crystal.txtでエラーが出るので修正
・doc/client_packet.txt更新

----------------------------------------
//0261 [2007/07/29] by Rayce

・@コマンド処理を高速化（atcommand.*, map.c）
　　　オープンハッシュを用いてコマンド文字列からatcommand_infoを検索します。
　　　特に@autolootや@changemaptypeなど比較的新しく追加されたコマンドに対する検索速度が劇的に
　　　向上します。

	-> COMMAND_HASH_SIZEを定義、デフォルトは127
	-> AtCommandInfoにnextメンバを追加、外部ハッシュのリスト用
	-> atcommand_create_hashtable() 追加、ハッシュテーブルを作成する
	   サーバ起動時のみ呼ばれる、@reloadatcommandでは呼ばれない
	-> command2hash() 追加、アルゴリズムはscript.cの calc_hash() と同じ
	-> get_atcommandinfo_byname() をハッシュ検索に変更
	-> コマンド名からatcommand_infoを参照する場合には get_atcommandinfo_byname() を利用する
	-> synonym_table_構造体のcommandメンバをconst char型に変更し、aStrdupしないように改善

・0253のbattle_auriga.confの tkcombo_delay_lower_limits を入れ忘れていた箇所を修正（battle.c）
・path_blownpos() を少し最適化、MAX_BLOWNPOSを定義（path.c）

----------------------------------------
//0260 [2007/07/28] by Rayce

・装備中のアイテムは矢作成スキルで矢に変換できないように修正（clif.c, skill.c）
	AthenaProject BTS報告 Mopyaさん and Cocoaさん thank's

・is_atcommand() を名前解析部分とコマンド実行部分に分離する merged from eA（atcommand.*, clif.c, script.c）
	コマンド実行部分は is_atcommand_sub() とする。
	スクリプトのgmcommand命令のように名前解析が不要な場面においてはこちらを使うことで無駄な処理を省略する。
	ついでに is_atcommand() の引数gmlvlを削っておく。

・以下の@コマンドに対してsynonymous commandを作った場合、正常に機能しなかった問題を修正（atcommand.c）
	@kamib, @kamic
	@monstermap
	@str, @agi, @vit, @int, @dex, @luk

----------------------------------------
//0259 [2007/07/28] by Rayce

・マキシマイズパワー使用中にログアウトして再度ログインすると、SPの減少速度が速くなるバグを修正
　（from AthenaProject BTS  skill.c, status.c）
	save/scdata.txtからステータス異常を復帰する場合、status_change_start() のtickには
	必ず残り時間が入っています。
	従って一定時間ごとに status_change_tiemr() 呼び出す必要のあるステータス異常は、タイマーの
	インターバルをtickではなくval2〜4のいずれかに入れるように統一します。
	tickは関数内部で書き換えるため、status_change_start() を呼び出すときのtickは0で構いません。

・上記の変更に合わせて以下のステータス異常を修正（skill.c, status.c）
	チェイスウォーク
	クローキング
	インビジブル
	属性場

・養子解体するとMAPサーバの接続が切断される致命的なバグを修正（char.c）
・養子の縁組および解体すると親の持っているカードスキルが消失してしまうバグが発生していたので、
　pc_calc_skill() を直接呼ぶのではなく status_calc_pc() を経由するように修正（chrif.c, pc.c）
・069以降、divorce関数で離婚成功しても常に0が返ってくるバグを修正（script.c）
・離婚および養子解体が成功したときはキャラデータをセーブするように強化（pc.c）

----------------------------------------
//0258 [2007/07/27] by Rayce

・AthenaProject2313よりmerge、thanks to Blazeさん
　　・以下のベインス追加NPCスキルを実装
	「アースクエイク」「ファイアブレス」「アイスブレス」「サンダーブレス」「アシッドブレス」
	「ダークネスブレス」「出血攻撃」「パルスストライク」「ヘルジャッジメント」「イビルランド」
　　・古く青い箱、古い紫色の箱、古いカード帖から得られるアイテムをラヘル時点に更新
	（item_bluebox.txt、item_violetbox.txt、item_cardalbum.txt）
　　・フィゲルのWarpを修正
	（npc_warp_town.txt）

・トルリョチャギの周囲へのスタン効果は skill_additional_effect() に記述するように修正（skill.c）
・skill_unit_onplace_timer() の一部を少し整形（skill.c）

----------------------------------------
//0257 [2007/07/27] by Rayce

・AthenaProject2312よりmerge、thanks to Blazeさん
　　・TheSignクエスト実装（npc_quest_thesign.txt）
　　・フィゲルクエスト2種実装、1種修正
	（npc_town_hugel.txt）
	（npc_town_airport.txt）
	（npc_town_lighthalzen.txt）
　　・ラヘルクエスト修正（npc_town_rachel.txt）
　　・ラヘル案内要員追加（npc_misc_guide.txt）
　　・ラヘルジョンダ職員のセーブ位置修正（npc_misc_zonda.txt）
　　・ラヘル新規追加頭装備作成NPC実装（一部未実装）（npc_quest_hat5.txt）
　　・ガンスリンガー武器作成クエスト5種実装（npc_job_28gunslinger.txt）
　　・初心者修練場で職業適性検査の結果と判定に相違が出ていたのを修正（npc_job_00novice.txt）
　　・キル・ハイルクエスト専用マップのwarpが2重化していたのを修正（npc_quest_kiel.txt）
　　・飛行船で新経路のラヘルの不具合修正（npc_town_airport.txt）
　　・ゲフェニアのテレポート不可を可に変更（mapflag.txt）

----------------------------------------
//0256 [2007/07/27] by Rayce

・db/job_db1.txtで読み込む武器のタイプがWT_MAXに対応してなかったのを修正（status.c）
・db/refine_db.txtの初期化時、MAX_WEAPON_LEVELに対応してなかったのを修正（status.c）

・conf/battle_auriga.confの pc_hit_stop_type をデフォルトで0に修正（battle.c）
　位置補正情報を送らないので所謂ヨーヨー現象が発生するようになります

----------------------------------------
//0255 [2007/07/26] by Rayce

・0244で保留にしていた bAddSkillHealRate の中身を実装（battle.c, skill.*）
　回復量補正は skill_fix_heal() で行う
　ついでにMAX_SKILL_HEAL_UPを10から5に縮小しておく
	merged from AthenaProject2311 thanks to ICOさん

　※指定可能なスキルは以下の通り
	ヒール
	治療の手助け
	応急手当
	ポーションピッチャー
	スリムポーションピッチャー
	君だけは護るよ
	あなたに尽くします
	カオティックベネディクション
	サンクチュアリ
	イドゥンの林檎
	カアヒ

・ランダムにセルを選択する機能はないので、map_searchrandfreecell() を
　map_searchfreecell() に改名（map.*, npc.c, skill.c）

・duplicate元のスクリプトと自身のMAPが異なる場合、duplicate元のスクリプトのMAPが読み込み対象外
　だとduplicateに失敗するので、duplicate元をMAP非配置型に修正しておく
	script/npc/quest/npc_quest_artifacts.txt
	script/npc/town/npc_town_airport.txt
	script/npc/town/npc_town_lighthalzen.txt

----------------------------------------
//0254 [2007/07/26] by Rayce

・AthenaProject2311よりmerge、thanks to ICOさん
　　・「カウプ」で魔法などが回避できなかった問題を修正（battle.c）
　　　　通常攻撃、およびプレッシャーを除く全てのスキル攻撃を1回だけ回避することができます
　　　　判定の優先順位は セイフティウォール > カウプ > ニューマ
　　・「カイト」で範囲魔法を反射できない不具合を修正（battle.c）
　　・「ソウルブレイカー」にカタール研究の効果が乗っている不具合を修正（battle.c）
　　・「喫煙」でダメージが発生する不具合を修正（battle.c, skill.c, db/skill_db.txt）
　　・@monster, @monstermap でMobがスタックすると召喚に失敗する問題を修正（atcommand.c）

----------------------------------------
//0253 [2007/07/26] by Rayce

・アイテムボーナスのステータス固定用の fix_status を構造体としてまとめる（map.h, pc.c, status.c）
・status_calc_pc() でステータス固定計算後にspeedとaspdの補正を行うように修正（status.c）
・@jumpで指定する座標を省略可能に拡張（atcommand.c）
　省略時は (0,0) と同義になりMAP内にランダムに飛ぶ

・battle_auriga.confに tkcombo_delay_lower_limits を追加（battle.*）
　	AGIとDEXが異常に大きい（350とか）場合、テコンの蹴り構えのモーションが短すぎて蹴りを発動
	できないバグが発生しているので、モンクのコンボと同様に最低入力保障時間を設けます

----------------------------------------
//0252 [2007/07/26] by Rayce

・ペットのルートアイテム検索について（pet.c）
	-> 最初にアイテムを見つけた時点で検索を中止していたバグを修正
	-> 検索範囲を 57x57 から 7x7 に縮小
	   ルートに行く射程距離は3なので7x7より広く検索する意味はない
	-> pet_ai_sub_hard_lootsearch() を少し修正

・map_readmap() で出力されるMAP番号を+1しておく（map.c）
・0251に添付し忘れていた conf/map_auriga.conf を追加
・MAP名に .gat が付いてなかった部分を修正（conf/map_auriga.conf）

----------------------------------------
//0251 [2007/07/26] by Rayce

・AthenaProject2310よりmerge、thanks to Blazeさん
　　・ラヘル実装
　　・ラヘルクエスト5種追加（npc_town_rachel.txt）
　　・飛行船に新経路追加（npc_town_airport.txt）
　　・ジョンダ職員追加（npc_misc_zonda.txt）
　　・宿屋NPC追加（npc_misc_inn.txt）
　　・各warp修正（npc_warp_town.txt、npc_warp_dun.txt）
　　・新規追加monsterの名称を修正
　　　（npc_monster_rafild.txt、npc_monster_rasan.txt、npc_monster_icedun.txt）
　　・mapflag修正（mapflag.txt）
　　・map_auriga.confをラヘル対応に更新、新マップ情報だけ追加

----------------------------------------
//0250 [2007/07/26] by Rayce

・AthenaProject2308よりmerge、thanks to Blazeさん
　　・アマツ通行手形クエスト修正（npc_town_amatsu.txt）
　　・バンジージャンプのHP計算を修正（npc_town_umbala.txt）
　　・ローグ転職クエストの一部箇所で進行不可になってしまうのを修正（npc_job_17rogue.txt）
　　・スロットエンチャントNPCを整形（npc_quest_slotenchant.txt）
　　・ノーグハルト追加ランダムアイテムをノーグハルト時点のデータで実装
　　　（item_petbox.txt、item_food.txt、item_mask.txt、item_jewel_box.txt）

----------------------------------------
//0249 [2007/07/26] by Rayce

・AthenaProject2306よりmergeの続き、thanks to ICOさん
　　・プレッシャーがエンペリウムに対してスキル使用失敗になるように修正（battle.c, skill.c）
　　・混乱状態の敵にパンボイスを使用した場合、相手の混乱状態を解除するように修正（skill.c）
　　・主人が死亡している時にもペットが支援攻撃した問題を修正（pet.c, pc.c）
　　・主人が9マスより遠くに離れるとペットが支援攻撃を止めるように仕様を変更（pet.c）
　　・見た目がPCではないMobが指弾を使うと一瞬姿が消えてしまう問題を修正（skill.c）

・PETのAIを少し最適化（pet.c）
	-> 親密度が0以下のときにルートアイテムの検索をしない
	-> 主人と距離が離れすぎているときにルートアイテムの検索をしない

----------------------------------------
//0248 [2007/07/25] by Rayce

・AthenaProject2306よりmerge、thanks to ICOさん
　　・運命のタロットカードの固定詠唱時間を通常詠唱時間に修正（db/skill_cast_db.txt）
　　・ソウルブレイカーの魔法ダメージ部分が対象のカード効果によって軽減されるように修正
　　　また属性軽減効果が二重に計算されていた問題を修正（battle.c）

　　・アイテムボーナスのHP/SPドレインの発動確率が合算で計算されていた不具合を修正
　　　（battle.c, map.h, pc.c, status.c）
　　　DrainRate系とDrainValue系はそれぞれ独立して発動確率を計算するようになります

　　・battle_auriga.confの「％吸収を有効にする」項目を「有効とする吸収タイプ」に変更（battle.*）
　　　デフォルトでは2で、DrainValue系による一定吸収のみが行われる
		magic_attack_drain_per_enable   → magic_attack_drain_enable_type
		misc_attack_drain_per_enable    → misc_attack_drain_enable_type
		weapon_reflect_drain_per_enable → weapon_reflect_drain_enable_type
		magic_reflect_drain_per_enable  → magic_reflect_drain_enable_type

　　・battle_weapon_attack() と battle_skill_attack() におけるHP/SP吸収処理を
　　　battle_attack_drain() にまとめる（battle.c）

　　・battle_auriga.confに mob_middle_boss_delay_rate, mob_mvp_boss_delay_rate を追加（battle.*, npc.c）
　　　通常MOB、中ボス、MVPボスそれぞれ別々に再出現までの時間の割合を設定できます

　　　※db/mob_db.txtのModeにBoss属性が設定されているかどうかだけで中ボスの判定を行います
　　　　Athenaのように出現時間には依存しないので注意してください

----------------------------------------
//0247 [2007/07/24] by Rayce

・AthenaProject2305よりmerge、thanks to number24さん
	-> MinGWのときは -lmysql を入れるように修正
	-> MySQLに関するリンカオプションの設定をトップのMakefileに集める
	-> doc/sqllogin.txtにMinGW環境下でコンパイルするときの注意点を追加

----------------------------------------
//0246 [2007/07/24] by Rayce

・AthenaProject2304よりmerge、thanks to Blazeさん
　以下Readmeより転載
　　・percenthealで-100以下のみ死亡判定を出すように修正
　　・テコン系列がレベルアップ時の支援効果を10分継続に修正（pc.c）
　　・NPCスキルの射程を修正（skill_db.txt）
　　・各スキルの消費SPを修正（skill_require_db.txt）

----------------------------------------
//0245 [2007/07/24] by Rayce

・AthenaProject2303より以下の項目についてmerge、thanks to ICOさん
	-> 死んだふり中に攻撃することができた不具合を修正（unit.c）
	-> 16bitおよび24bitカラーのギルドエンブレムをデフォルトで使用できるように
	   battle_auriga.confの guild_emblem_colors を3に変更しておく
	-> doc/db_ref.txtに召喚系スキルについての説明を追記

----------------------------------------
//0244 [2007/07/24] by Rayce

・AthenaProject2303より、以下のアイテムボーナス13種を追加、thanks to ICOさん
　スキルの固定詠唱時間の補正は skill_castfix() 内にまとめる
	bFixMaxHP
	bFixMaxSP
	bFixBaseAtk
	bFixMatk
	bFixDef
	bFixMdef
	bFixHit
	bFixCritical
	bFixFlee
	bFixAspd
	bFixSpeed
	bAddFixCastRate
	bAddSkillHealRate

　※bAddSkillHealRateについては準備をしただけで実際の効果は未実装にしています

----------------------------------------
//0243 [2007/07/23] by Rayce

・コマンドライン引数の仕様を変更 merged from eA
　　今までは例えばMAPサーバであれば、コマンドライン引数の第一引数がmap_auriga.confへのパス、
　　第二引数がbattle_auriga.confへのパス、というように一意的に決まっていましたが、非常に使い
　　勝手が悪いので仕様を変更します。
　　以下に示すコマンドを使って各confファイルへのパスを変更することができます。

　　login-server
　　　　--login-config <filename>

　　char-server
　　　　--char-config <filename>
　　　　--inter-config <filename>

　　map-server
　　　　--map-config <filename>
　　　　--battle-config <filename>
　　　　--atcommand-config <filename>
　　　　--script-config <filename>
　　　　--msg-config <filename>

　　これらは同一マシンで複数のキャラサーバやマップサーバを動かすときに有用です。
　　詳細は doc/distribute_servers.txt に記載してあるので参考に。

　　※eAにあるコマンド --help と --version は特に必要性を感じなかったためmergeしてません。

・auriga-startの修正
	-> 上記のコマンドライン引数仕様変更に対応
	-> 新規作成された ./save/account.txt に\tが一つ不足していたので修正
	-> saveファイルを新規作成する際、win32_start.batと同様に以下の3つのファイルも作成する
	   　./save/accreg.txt
	   　./save/g_storage.txt
	   　./save/scdata.txt

・grf-files.txtへのファイルパスはコマンドライン引数からではなくmap_auriga.confで設定するように変更
　conf/map_auriga.confに grf_path_txt キーを追加（map.c）
・マップキャッシュmap.infoはカレントディレクトリに作成するようにデフォルト設定を変更（map.c）
・pc_memo() を少し修正（pc.c）

・srand() および atn_srand() による種まきはmainでまとめて行うように変更（core.c, login.c, map.c）
・VCのときに使うランダム定義がRANDOMSTD2XになっていたのでRANDOM64に修正
　ついでに書き換えて簡素化（utils.h）

・doc/server_build.txtに少し加筆
・doc/distribute_servers.txtに情報加筆

----------------------------------------
//0242 [2007/07/23] by Rayce

・ROメールシステムの設計見直し（int_mail.*, clif.*, intif.c）
	-> mail_dataを取得するときにメモリをアロケートしないように改善
	   mail_free() は不要になったので撤廃
	-> 最大受信数30を越える場合、送信成功として扱われるがデータそのものは破棄するようにしておく
	   サクライの詳細な実装が不明なのでこれは当面の間これを仕様とする
	   添付アイテム、Zenyもろとも消えてしまうので注意すること
	-> mail構造体のstoreはメールデータの個数を保有する重要な変数なので、エラーが発生しないように
	   値が異常でないかどうかチェックする
	   異常時は「stored number mismatch!!」の警告が出ますが、内部で自動的に正しい値に補正されます

・キャラ名からキャラ情報を直接取得できるように char_nick2id() を char_nick2chardata() に変更（char.*, int_mail.c）
・ROメールを同一アカウントの他キャラクターに送信しようとすると添付アイテムが消失してしまうバグを修正（int_mail.c）

----------------------------------------
//0241 [2007/07/22] by Rayce

・0239以降、db_clear() と db_final() のtableがNULLだったときサーバクラッシュする問題を修正（db.c）
・mob_data構造体のメンバrecall_flagをビットフィールドに変更（map.h, mob.c, skill.c）
・calc_hash() の中に SCRIPT_HASH_SIZE の剰余計算を丸め込む（script.c）
・DEBUG_HASHの出力書式を整理（script.c）

----------------------------------------
//0240 [2007/07/21] by Rayce

・MAPサーバ停止時の終了処理の高速化（npc.c）
	do_final_npc() でMAPに出現中のMOBを削除する際は、一旦復活しないMOBに設定してから
	unit_remove_map() を呼び出します。
	これより不要な再出現タイマーの設定処理が省略されます。
	また map_id2bl() を2回呼ぶ必要がなくなります。
	PETとHOMがまだMAPに残っているはずはないのですが、念のため unit_free() で後始末します。

　※大変荒い実験な上に状況によってマチマチですが、処理速度が約2倍になっていることを確認しました

・monster定義で設定したMOBの座標が完全にスタック位置だった場合、警告を出力してMOBの出現を取り消す
　ように修正（npc.c, mob.c）
	範囲内の空きセルをランダムで50回検索しても空きセルが見つからなかった場合は1秒後に検索を
	やり直す仕様になっています。
	しかし指定座標の周囲に全く空きセルがない場合は検索失敗になるのは確実であり、そのために常に
	1秒毎に検索を行い続けるのは負荷にしかなりません。
	従って最初の mob_spawn() に失敗した場合は map_searchrandfreecell() で空きセルのチェックを
	行うようにします。
	チェックに引っ掛かったらデータは破棄します。
	このとき再検索用の1秒タイマーは動いたままになっているので、mob_spawn() のnullpoチェックは
	外すように変更しています。

・以下のスクリプトにおいて上記の変更により警告が出るのでコメントアウト
	monster/dungeon/npc_monster_ctower.txt
	monster/dungeon/npc_monster_gefdun.txt
	monster/dungeon/npc_monster_izdun.txt
	monster/dungeon/npc_monster_treasure.txt
	monster/field/npc_monster_cmdfild.txt
	monster/field/npc_monster_mjolnir.txt
	monster/field/npc_monster_prtfild.txt

----------------------------------------
//0239 [2007/07/21] by Rayce

・メモリ消費を若干節約するため、dbn構造体のメンバcolorとdeletedをint型からchar型に変更してみる（db.h）
・db_clear() 内部で db_erase() を使えるようにするため db_foreach() ではなく db_final() の処理方法を
　利用するように修正（db.c）
	db_final() の処理本体を db_clear_sub() として分離して共用化

・MAPサーバ停止時、キャラを全て切断した直後にcharサーバにパケットを送信するように修正（chrif.*, map.c）
	プレイヤーがまだ残ったままの状態でサーバ停止すると全キャラのデータをセーブすることになり
	ますが、mmo_charstatus構造体は比較的大きい（1人当たり約12kB）ため、パケットサイズがかなり
	大きくなります。
	従って切断が完了した時点で chrif_flush_fifo() を呼び出してパケットを送信しておきます。
	charサーバがこの大きなパケットを処理している間に do_final_battle() 以下の時間の掛かる処理を
	行うことにより、Auriga全体の終了処理の高速化が見込まれます。

----------------------------------------
//0238 [2007/07/21] by Rayce

・map_searchrandfreecell() をより汎用に使える関数に変更（map.*, skill.c）
　第1引数のcell_xy型をNULLにすると、空きセルのリストは返さず空きセルの数だけを取得できます

・以下の条件でペットの卵情報が削除されずセーブデータにゴミが残り続ける問題を修正（mob.c, unit.c）
	-> mobにペットの卵をルートさせたままの状態でサーバを停止する
	-> ペットの卵をルートしたmobを@killmonster2で消去する
	-> ペットの卵をルートしたmobをペットとして捕獲する

----------------------------------------
//0237 [2007/07/21] by Rayce

・0182の clif_parse_GuildRequestInfo() に関する変更を巻き戻す（clif.c, guild.c, map.h）
	各種ギルド情報が上手く更新されなかったりと色々問題が生じているようなので
	巻き戻すことにします。
	何が良い手が浮かんだら再度取り掛かるかもしれません。

・あまり意味のないlast_deadtimeをmob_data構造体から削除（map.h, unit.c）

----------------------------------------
//0236 [2007/07/18] by Rayce

・db_insert() および linkdb_replace() の返り値を変更（db.*）
	データを置換する前のdataをvoid*型で返すようにします
	データの新規追加の場合はNULLが返ってきます
・treedbおよびlinkdbに関して、searchが不要な部分を短縮して検索処理効率を上げるように改善
　（friend.c, guild.c, npc.c, script.c）

・TXT: 0227以降、ギルド告知や役職に#が連続で付加するバグが発生していたので修正
　（int_guild.c, char-converter.c）

----------------------------------------
//0235 [2007/07/17] by Rayce

・DEBUG_VARSの出力結果を元に修正（db/item_db.txt）
	bonus bUnbreakableArmor,n; → bonus bUnbreakableArmor,0;
・スクリプトの命令/関数/ラベル/変数のデータ量が増えてきたので、SCRIPT_HASH_SIZEを1021に引き上げ（script.c）
	外部ハッシュに繋がれるのがだいたい4〜5個くらいに集約

・SQL: GCCのときにコンパイルエラーになっていたので修正（int_guild.c）

----------------------------------------
//0234 [2007/07/17] by Rayce

・アカウント名、キャラクター名、Emailの文字数制限を tool/ladmin, tool/cgi/, tool/php の各ファイルに
　対しても適用するように修正
	アカウント名   : 24 → 23文字
	キャラクター名 : 24 → 23文字
	Email          : 40 → 39文字

　※0200から行ってきたバッファオーバーラン対策はこれで完了です。
　　念のためセーブデータの整合性を再度確認しておくと良いです。

・db/packet_db.txtを0x2bcまで更新
・doc/client_packet.txtに情報追加

----------------------------------------
//0233 [2007/07/17] by Rayce

・SQL: converterの整理
	バッファオーバーフロー対策のための文字数制限を適用
	出来るだけlogin, char, interからコピペしたものに置換

----------------------------------------
//0232 [2007/07/17] by Rayce

・NPC定義のチェックを強化（npc.c）
　以下のように余計な文字が含まれる場合、"bad ??? declaration : ???" が表示されエラーとなります。
　警報が鳴るように強化されているので注意してください。
　またエラー箇所を特定しやすくするため、エラー行が出力されるように改善されています。

　　１）script定義に ,0 が余計に付いている
　　　　	prontera.gat,164,190,4,0	script	Test(1)	112,{}
　　２）duplicate定義の () の後ろにさらに ) が存在している
　　　　	prontera.gat,164,190,4	duplicate(Test(1))	Test2	113
　　３）warp定義の末尾に ,4 が余計に付いている
　　　　	prontera.gat,150,188	warp	000	1,1,izlude.gat,130,115,4
　　４）mob定義に ,0 が一つ多い
		prontera.gat,0,0,0,0,0	monster	--ja--	1002,1,1000,1000
　　５）mapflag定義に座標はない
　　　　	prontera.gat,0,0	mapflag	nomemo	dummy

　※BCC特有のsscanfバグにより、npc_parse_mapflag() だけは%n変換を使えません。
　　strlenで文字列長をチェックして余計な文字が残ってないかの判定を行っています。

・warp定義において、向き指定は省略可能であることを正式な仕様とする（npc.c）
　以下は今まで同様どちらも正常です。
	prontera.gat,148,188,0	warp 001	1,1,izlude.gat,132,115
	prontera.gat,148,186	warp 002	1,1,izlude.gat,132,115
　battle_auriga.confのwarp_point_debugがyesのときに向きを指定できるだけであり、基本的には不要です。
　詳細はdoc/script_ref.txtを参照。

・上記変更によりエラーとなるスクリプトの修正
	script/npc/town/geffen.txt
	script/npc/town/morocc.txt
	script/npc/town/niflheim.txt

----------------------------------------
//0231 [2007/07/17] by Rayce

・mapreg_setregstr() のコードを簡素化（script.c）
・文字列型のMAP永続変数において、1023文字まではデータの有効性を保証するように修正（script.c）
	文字列データのロードおよびセーブが正常に行われることを意味します。
	これよりも長い文字数を使った場合の挙動は未定義とします。

・doc/script_ref.txtに変数名として使える最大文字数に関する情報を追記
・SQL: MAP永続変数名として利用可能な最大文字数をTXTに合わせて255文字までに制限

・TXT: BCCのみsave/account.txtの%newid%行の読み込みに失敗するバグを修正（login.c）
・TXT: save/party.txtの読み込み時に%newid%行のチェックは不要なので省略する（int_party.c）
・TXT: save/guild.txtの読み込み時の空ギルドチェックを省略する（int_guild.c）
	この時点で guild_txt_delete() を呼び出すとギルド倉庫のデータが削除されずにゴミが残り続けたりするなど
	処理が中途半端になってしまうため。
	どちらにせよ mapif_parse_GuildInfo() で空ギルドチェックは行われるので問題はない。

----------------------------------------
//0230 [2007/07/16] by Rayce

・0225以降、##変数を保存するときにcharサーバがクラッシュする致命的なバグを修正（char.c）

・TXT: save/accreg.txtの読み込み時に、各データが半角スペースで区切られているかどうかのチェックを入れる（inter.c）
・TXT: ##変数が多量に登録されているとき、全ての##変数を読み込めない可能性のあるバグを修正（login.c）
・TXT: BCCのみ##変数の読み込みに失敗する可能性のあるバグを修正（login.c）
	save/accreg.txtと同じ処理方法に変更、詳細はAthena-Readme1593を参照

----------------------------------------
//0229 [2007/07/15] by Rayce

・バッファオーバーフロー対策の文字数制限、0225の続き（login.c）
	アカウントID 24 → 23
	アカウントパスワード 24 → 23
	アカウントメールアドレス 40 → 39
	##変数の名前 32 → 31

・login.cの全体的な修正および整形
　　　-> sex番号からsex文字への変換は sex2str[] を使うように
　　　-> mmo_auth() でアカウントが見つからなかった場合、パスワードの暗号化が有効なときはlog/login.logに
　　　   パスワードを出力しないように修正
　　　   暗号化されているパスワードを書かれても文字化けで意味がないため
　　　-> パケット0x277は暗号化されてないログイン要求らしいので修正
　　　-> コードを簡潔にするためTXTのときもlastipを保存するように変更してみる
　　　   ただしセーブデータとして書き出されるのは従来通りSQLのみ
　　　-> account_load_str() を呼び出す場合、引数となる文字列の末尾には必ず \0 を付けるように修正
　　　   SQLのときに関数内部でsprintfするため \0 がないとバッファオーバーランが発生する
　　　-> login_httpd_auth_func() のuseridの文字列長が信頼できないのでstrnlenでチェックする

・strnlenが使えない環境のために自作のstrnlenをeAから移植（unit.*）

----------------------------------------
//0228 [2007/07/14] by Rayce

・0222の時点でコンパイルエラーになっていたので修正（clif.c）
・int_homun.c, int_party.c, int_pet.c, int_storage.cの細かい整形
・バッファオーバーフロー対策のための文字数制限、0225の続き
	ホムの名前 24 → 23
	パーティ名 24 → 23
	パーティメンバー名 24 → 23
	ペットの名前 24 → 23

・SQL: 以下で利用されてないフィールドをSELECTしないように修正
	`homun_id` （int_homun.c）
	`party_id` （int_party.c）
	`pet_id`   （int_pet.c）
	`char_id`  （int_status.c）

----------------------------------------
//0227 [2007/07/14] by Rayce

・ギルド関連についてバッファオーバーフロー対策のための文字数制限、0225の続き（int_guild.c）
	ギルド名 24 → 23
	ギルドマスター名 24 → 23
	ギルドメンバー名 24 → 23
	ギルドの役職名 24 → 23
	ギルド追放時メッセージ 40 → 39

・int_guild.cの細かい修正と整形
	-> MAX_GUILDLEVELの値を増やしても50までしかギルドLvが上がらなかったバグを修正
	-> mapif_parse_GuildSkillUp() でスキルLvのチェックをしないように修正
	   既に判定はguild.cで行われているのでパケットの内容を信頼する
	-> SQL: guild_sql_load_num() で利用しない `guild_id` をSELECTしないように修正

・ギルド情報取得時に発生させるイベント名の末尾に \0 を強制するように修正（guild.c）
・guild_member_added() でメンバーの追加に失敗したとき、末尾に \0 を強制するために
　msg_txt() を一旦バッファにコピーしてから intif_guild_leave() を呼ぶように修正（guild.c）

----------------------------------------
//0226 [2007/07/14] by Rayce

・キャラ永続変数およびアカウント永続変数が31文字で制限されるように修正、0225の続き
　（inter.c, chrif.c, intif.c, pc.c）
・inter.*の細かい整形

・map_auriga.confのuserid, passwdを24→ 23文字に制限（chrif.c）
・wisの拒否リストに保存するキャラ名の末尾に \0 を強制するように修正（clif.c）

----------------------------------------
//0225 [2007/07/14] by Rayce

・char.cの細かい整形
・バッファオーバーフロー対策のため一部の文字列の末尾に '\0' を強制するように修正（char.c）
	キャラ名 24 → 23文字まで
	永続変数 32 → 31文字まで
	char_auriga.confのuserid 24 → 23文字まで
	char_auriga.confのpasswd 24 → 23文字まで

　※0200から少しずつ対策を施してきましたが、ここからはセーブデータに関与する部分について修正を行います。
　　利用可能な文字数が規定よりも1つ減らされます。
　　今まで長い文字列が使われていた場合は注意してください。
　　最大文字数を越えるものは自動的に安全な文字数まで切り詰められるので、キャラ名が変わってしまったり
　　セーブデータ自体が壊れてしまう可能性があります。
　　セーブデータのバックアップを取った上で十分検討してください。

----------------------------------------
//0224 [2007/07/14] by Rayce

・ROメールの削除を失敗したとき「削除できませんでした」のメッセージが出力されないバグを修正（clif.c, intif.c）

・int_mail.cの全体的な修正と整形
　　-> 送信者名、受信者名、タイトルの末尾に \0 を強制する
　　-> mail_dataのアイテムソート用idがunsigned intになってなかったのを修正、%d → %u
　　-> mapif_parse_OpenMailBox() でメールがロードできなかったときは念のためmail_dataを
　　　 NULLで埋め尽くすようにしておく
　　-> TXT: mail_data用のfilenameがバッファオーバランしないようにサイズを変更、1024 → 1056
　　-> TXT: mail_dataを保存する際は lock_fopen(), lock_fclose() を利用する
　　-> SQL: mail_sql_store_mail() でbody_dataにわざわざデータを変換する無駄を省略
　　-> SQL: mail_sql_load() で必要のない `char_id` をSELECTしないように改善

----------------------------------------
//0223 [2007/07/14] by Rayce

・pet_delete() を呼び出すとき、card[1]ではなくcard[2]を参照していたためにペットデータが削除されなかった
　バグを修正（char.c, int_storage.c）

・キャラクターを削除するとき、ROメールに添付されたペットの卵情報が削除されずセーブデータにゴミが残り
　続ける問題を修正（int_mail.c）
・アイテムやZenyが添付されたままのROメールを削除できないように修正（int_mail.c）
	通常はクライアント側で判定が行われ、以下のメッセージが出力されるだけで0x254のパケットは送信されません。
	「削除しようとしているメールに受け取っていないアイテムが存在します。」
	しかしhacker対策としてinterサーバでも添付アイテムの存在をチェックするように強化します。

・TXT: mail_txt_deletemail() のmemcpy部分を少し改善（int_mail.c）

----------------------------------------
//0222 [2007/07/13] by Rayce

・clif.cの細かい整形
	-> clif_parse_ChangeDir() のセキュリティ対策
	-> clif_parse_HomActionRequest() から2005-05-09dRagexeに対するデコード処理部分を抹消
	-> webchat_message() のsprintfをsnprintfに修正
・動作に影響しないレベルの細かい整形（src/common, src/map）

----------------------------------------
//0221 [2007/07/13] by Rayce

・path.cから経路探索ルーチン単体テスト関数を抹消（path.c）
・intif.cの細かい整形
	-> intif_GMmessage() を少し変更
	-> intif_parse_GuildMemberInfoChanged() から不要な代入を削除
・guild.cの細かい整形
	-> db/castle_db.txtで指定できるMap_Name, Castle_Name, Event_Nameを23文字までに制限
	-> guild_broken() でメモリをアロケートしなくて済むように改善

----------------------------------------
//0220 [2007/07/12] by Rayce

・バッファオーバーラン対策として文字列の末尾に \0 を強制するように修正（core.c, httpd.c, socket.c）
・windows環境で吐き出されるcrashdump.logの改行コードをCR/LFに修正（core.c）
・httpd.cの細かい整形
	-> httpd_strcasencmp() の代わりにstrcasecmpを使う
	-> httpd_pages() 用の関数ポインタを HttpdFunc型 としてtypedefする
	-> rand() を atn_rand() に変更

----------------------------------------
//0219 [2007/07/12] by Rayce

・ROメールにアイテムやZenyを添付するとき、idxが不正な値の場合は弾くようにチェック強化（mail.c）
・mail_checkappend() をstaticに変更（mail.*）
・clif_parse_GuildRequestInfo() で先にtypeの不正チェックを行うように修正（clif.c）

・SC_INCMSP2によるMAXSP増加の計算タイミングを少し変更（status.c）
・status.cの動作に影響しないレベルの細かい整形

----------------------------------------
//0218 [2007/07/11] by Rayce

・0202におけるgetpetinfo関数およびgethomuninfo関数の変更点を巻き戻し
　これまでの修正によりペットとホムの名前には \0 が入ることが保証されたのでaStrdupを使う（script.c）
・setmapflag命令でnosaveを指定する際、MAP名を15文字までに制限（script.c）

・map_session_data構造体のメンバwarp_waitingをビットフィールドに変更（map.h, skill.c, unit.c）
・ranking.c, unit.cの細かい整形

----------------------------------------
//0217 [2007/07/11] by Rayce

・ペットの名前を23文字までに制限（pet.c）
・動作に影響しないレベルの細かい整形（chat.c, mob.c, party.c, pet.*）

----------------------------------------
//0216 [2007/07/11] by Rayce

・battle_auriga.confのpet_loot_typeが0のとき、ペットが過剰にアイテムをルートする際に
　重量が変化しなかったバグを修正（pet.c）
・倉庫を開いているときだけ以下のタイミングで storage_storage_save() を呼び出すように修正（clif.c, homun.c, pet.c）
	ホムの削除時
	ペットの卵の孵化時
	ペットを卵に戻す時
	battle_auriga.confのpet_leaveがyesのときでペットが親密度0で消える時
	battle_auriga.confのsave_player_when_drop_itemがyesのときでアイテムを床に落とした時

・mapif_create_pet() でペットの新規作成に失敗した場合にはfreeするように修正（int_pet.c）
・GCCにおいて map_getcellp() で警告が出ていたので修正（map.c）

----------------------------------------
//0215 [2007/07/10] by Rayce

・アクセス違反が発生する可能性を修正
	-> pet_select_egg() で不正なindexが送信されてくるのを防ぐ（pet.c）
	-> guild_created() でエンペリウムが見つからないときのチェックを考慮する（guild.c）
	-> db/skill_db.txtのinf2に8192のフラグがセットされているスキルについて、
	   スキルLvが11以上の場合にはスキルLv10と同じ消費アイテムチェック処理にする（skill.c）

・homun_callhom() でエンブリオを検索する際に pc_search_inventory() を使うように修正（homun.c）
・removecards_sub() の > を >= に修正（script.c）
・skill_weapon_refine() で pc_search_inventory() を二重に呼ばないように改善（skill.c）
・battle_skill_attack() のカイトの部分で「水晶のかけら」を検索する際、不必要な個数チェックを省略（battle.c）
・ポーションピッチャーおよびスリムポーションピッチャーをスキルLv11以上で使う場合、
　スキルLv10と同じアイテムを使用するように変更（skill.c）

・csv_data構造体へのキャストを明示してなかった箇所を修正（script.c）
・script.cの細かい整形

----------------------------------------
//0214 [2007/07/10] by Rayce

・ユーザー定義関数として使える関数名を49文字までに制限（npc.c）
・npc_parse_script(), npc_parse_function() を少しだけ改善（npc.c）
・skill.cで使う WARP_CLASS はnpc.hから取得するように変更（skill.c）
・npc.cの細かい整形

----------------------------------------
//0213 [2007/07/09] by Rayce

・mob.cの細かい整形（mob.*）
	-> イベントを持っているMobを倒したときバッファアンダーフローが起こる可能性を修正
	-> mob_ai_sub_hard() で攻撃されたかの確認を行う際、チェックが二重に行われる無駄を修正
	-> db/mob_db.txtで指定可能なモンスター名の文字数を23文字までに制限する
	-> db/mob_skill_db.txtにMOB_ID_MAXを越える値をIDとして指定した場合にサーバクラッシュするバグを修正
	-> db/mob_skill_db.txtにMAX_MOBSKILLを越える数のスキルを登録しても「readdb: too many skill」の警告が
	   出力されなかったバグを修正

----------------------------------------
//0212 [2007/07/08] by Rayce

・mail.cの細かい整形（mail.c）
	-> nullpoチェックを入れる
	-> ROメールの受信者およびタイトルの末尾に \0 を付加する

・map.cの細かい整形（map.c）
	-> block_free_max を BLOCK_FREE_MAX に改名
	-> BL_LIST_MAX はblock_list構造体用のtypeと混同するので BLOCK_LIST_MAX に改名
	-> map_calc_dir() の最適化
	-> MAP名の末尾に \0 を付加する

・sleep_data構造体を無名構造体に変更（script.h）
・以下の入れ子になった構造体を外に分離する（db.h, map.c, map.h, script.h）
	db_free
	map_cache_head
	pet_skill_attack
	pet_skill_support
	script_stack

----------------------------------------
//0211 [2007/07/08] by Rayce

・ランダム系アイテムデータベースを読み込む際、存在しないアイテムのIDが指定されていた場合は
　読み込み対象外にするように修正（itemdb.c）
・db/item_db.txtで指定可能なアイテムの日本語名および英語名を47文字までに拡張（itemdb.c）
	現時点で idnum2itemdisplaynametable.txt に記載されている最長のアイテム名が37文字でした。
	これらをカバーするため文字数制限を32文字から47文字に引き上げます。
	バッファオーバーラン対策により末尾には \0 を強要するため、48文字ではなく47文字です。
・@idsearchの処理を最適化（atcommand.c, itemdb.*）
	itemdb_idsearch() を追加。
	numdb_foreach() を使うので効率良く検索が行われます。
	itemdb.cにあった変数 max_itemid および itemdb_getmaxid() は不要になったので削除。
・@idsearchでスロット数を表示するように機能拡張（atcommand.c, msg_auriga.conf）
・itemdb.cの細かい整形

----------------------------------------
//0210 [2007/07/07] by Rayce

・lock.cでバッファオーバーランが発生する可能性を修正（lock.c）
・0208においてatcommand.cで警告が出ていたので修正
	-> 抜け落ちていたreturnを補完（atcommand.c）
	-> pc_setpos() の引数にconstを付ける（pc.*）

----------------------------------------
//0209 [2007/07/07] by Rayce

・ホムが消えるとき、泣きエモタイマーが即座に削除されないバグを修正（unit.c）
・HPが0のホムを召喚してしまった場合は unit_free() で削除するように修正（homun.c）
・homun_get_create_homunid() を簡素化（homun.c）
・ホムの名前を23文字に制限する（homun.c）
	バッファオーバーラン対策のため、db/homun_db.txtおよびリネーム時で使える文字数が
	24 → 23に変更されます
・動作に影響しないレベルの細かい整形（homun.*）

----------------------------------------
//0208 [2007/07/06] by Rayce

・battle_addmastery() でデーモンベインのダメージ加算計算に浮動小数演算を使わないように変更（battle.c）
・atcommand.cの全体的な整形
	不要なmemsetを撤廃
	@iconの第二引数省略時はONになるように拡張

----------------------------------------
//0207 [2007/07/06] by Rayce

・ペットの卵を倉庫に入れたとき装備品目に置かれなかった問題を修正（clif.c）
・unit_walktodir() を pc_runtodir() と同様に修正（unit.c）
・取引時の距離チェックは unit_distance2() を利用するように変更（trade.c）

・skill.cの全体的な細かい整形
・skill_check_condition2_pc() の「ソウルリンカーで使えないスキル」の部分をまとめ直し（skill.c）
	battle_config.soul_linker_battle_modeの使い方がおかしかったので修正
	battle_config.soul_linker_battle_mode_kaが何故か使われてなかったので修正

----------------------------------------
//0206 [2007/07/06] by Rayce

・サーバースナップショット（version.h）
・不要なファイルをフォルダごと削除
	./bin
	./script/mob
