----------------------------------------
//0232 [2007/07/17] by Rayce

・NPC定義のチェックを強化（npc.c）
　以下のように余計な文字が含まれる場合、"bad ??? declaration : ???" が表示されエラーとなります。
　警報が鳴るように強化されているので注意してください。
　またエラー箇所を特定しやすくするため、エラー行が出力されるように改善されています。

　　１）script定義に ,0 が余計に付いている
　　　　	prontera.gat,164,190,4,0	script	Test(1)	112,{}
　　２）duplicate定義の () の後ろにさらに ) が存在している
　　　　	prontera.gat,164,190,4	duplicate(Test(1))	Test2	113
　　３）warp定義の末尾に ,4 が余計に付いている
　　　　	prontera.gat,150,188	warp	000	1,1,izlude.gat,130,115,4
　　４）mob定義に ,0 が一つ多い
		prontera.gat,0,0,0,0,0	monster	--ja--	1002,1,1000,1000
　　５）mapflag定義に座標はない
　　　　	prontera.gat,0,0	mapflag	nomemo	dummy

　※BCC特有のsscanfバグにより、npc_parse_mapflag() だけは%n変換を使えません。
　　strlenで文字列長をチェックして余計な文字が残ってないかの判定を行っています。

・warp定義において、向き指定は省略可能であることを正式な仕様とする（npc.c）
　以下は今まで同様どちらも正常です。
	prontera.gat,148,188,0	warp 001	1,1,izlude.gat,132,115
	prontera.gat,148,186	warp 002	1,1,izlude.gat,132,115
　battle_auriga.confのwarp_point_debugがyesのときに向きを指定できるだけであり、基本的には不要です。
　詳細はdoc/script_ref.txtを参照。

・上記変更によりエラーとなるスクリプトの修正
	script/npc/town/geffen.txt
	script/npc/town/morocc.txt
	script/npc/town/niflheim.txt

----------------------------------------
//0231 [2007/07/17] by Rayce

・mapreg_setregstr() のコードを簡素化（script.c）
・文字列型のMAP永続変数において、1023文字まではデータの有効性を保証するように修正（script.c）
	文字列データのロードおよびセーブが正常に行われることを意味します。
	これよりも長い文字数を使った場合の挙動は未定義とします。

・doc/script_ref.txtに変数名として使える最大文字数に関する情報を追記
・SQL: MAP永続変数名として利用可能な最大文字数をTXTに合わせて255文字までに制限

・TXT: BCCのみsave/account.txtの%newid%行の読み込みに失敗するバグを修正（login.c）
・TXT: save/party.txtの読み込み時に%newid%行のチェックは不要なので省略する（int_party.c）
・TXT: save/guild.txtの読み込み時の空ギルドチェックを省略する（int_guild.c）
	この時点で guild_txt_delete() を呼び出すとギルド倉庫のデータが削除されずにゴミが残り続けたりするなど
	処理が中途半端になってしまうため。
	どちらにせよ mapif_parse_GuildInfo() で空ギルドチェックは行われるので問題はない。

----------------------------------------
//0230 [2007/07/16] by Rayce

・0225以降、##変数を保存するときにcharサーバがクラッシュする致命的なバグを修正（char.c）

・TXT: save/accreg.txtの読み込み時に、各データが半角スペースで区切られているかどうかのチェックを入れる（inter.c）
・TXT: ##変数が多量に登録されているとき、全ての##変数を読み込めない可能性のあるバグを修正（login.c）
・TXT: BCCのみ##変数の読み込みに失敗する可能性のあるバグを修正（login.c）
	save/accreg.txtと同じ処理方法に変更、詳細はAthena-Readme1593を参照

----------------------------------------
//0229 [2007/07/15] by Rayce

・バッファオーバーフロー対策の文字数制限、0225の続き（login.c）
	アカウントID 24 → 23
	アカウントパスワード 24 → 23
	アカウントメールアドレス 40 → 39
	##変数の名前 32 → 31

・login.cの全体的な修正および整形
　　　-> sex番号からsex文字への変換は sex2str[] を使うように
　　　-> mmo_auth() でアカウントが見つからなかった場合、パスワードの暗号化が有効なときはlog/login.logに
　　　   パスワードを出力しないように修正
　　　   暗号化されているパスワードを書かれても文字化けで意味がないため
　　　-> パケット0x277は暗号化されてないログイン要求らしいので修正
　　　-> コードを簡潔にするためTXTのときもlastipを保存するように変更してみる
　　　   ただしセーブデータとして書き出されるのは従来通りSQLのみ
　　　-> account_load_str() を呼び出す場合、引数となる文字列の末尾には必ず \0 を付けるように修正
　　　   SQLのときに関数内部でsprintfするため \0 がないとバッファオーバーランが発生する
　　　-> login_httpd_auth_func() のuseridの文字列長が信頼できないのでstrnlenでチェックする

・strnlenが使えない環境のために自作のstrnlenをeAから移植（unit.*）

----------------------------------------
//0228 [2007/07/14] by Rayce

・0222の時点でコンパイルエラーになっていたので修正（clif.c）
・int_homun.c, int_party.c, int_pet.c, int_storage.cの細かい整形
・バッファオーバーフロー対策のための文字数制限、0225の続き
	ホムの名前 24 → 23
	パーティ名 24 → 23
	パーティメンバー名 24 → 23
	ペットの名前 24 → 23

・SQL: 以下で利用されてないフィールドをSELECTしないように修正
	`homun_id` （int_homun.c）
	`party_id` （int_party.c）
	`pet_id`   （int_pet.c）
	`char_id`  （int_status.c）

----------------------------------------
//0227 [2007/07/14] by Rayce

・ギルド関連についてバッファオーバーフロー対策のための文字数制限、0225の続き（int_guild.c）
	ギルド名 24 → 23
	ギルドマスター名 24 → 23
	ギルドメンバー名 24 → 23
	ギルドの役職名 24 → 23
	ギルド追放時メッセージ 40 → 39

・int_guild.cの細かい修正と整形
	-> MAX_GUILDLEVELの値を増やしても50までしかギルドLvが上がらなかったバグを修正
	-> mapif_parse_GuildSkillUp() でスキルLvのチェックをしないように修正
	   既に判定はguild.cで行われているのでパケットの内容を信頼する
	-> SQL: guild_sql_load_num() で利用しない `guild_id` をSELECTしないように修正

・ギルド情報取得時に発生させるイベント名の末尾に \0 を強制するように修正（guild.c）
・guild_member_added() でメンバーの追加に失敗したとき、末尾に \0 を強制するために
　msg_txt() を一旦バッファにコピーしてから intif_guild_leave() を呼ぶように修正（guild.c）

----------------------------------------
//0226 [2007/07/14] by Rayce

・キャラ永続変数およびアカウント永続変数が31文字で制限されるように修正、0225の続き
　（inter.c, chrif.c, intif.c, pc.c）
・inter.*の細かい整形

・map_auriga.confのuserid, passwdを24→ 23文字に制限（chrif.c）
・wisの拒否リストに保存するキャラ名の末尾に \0 を強制するように修正（clif.c）

----------------------------------------
//0225 [2007/07/14] by Rayce

・char.cの細かい整形
・バッファオーバーフロー対策のため一部の文字列の末尾に '\0' を強制するように修正（char.c）
	キャラ名 24 → 23文字まで
	永続変数 32 → 31文字まで
	char_auriga.confのuserid 24 → 23文字まで
	char_auriga.confのpasswd 24 → 23文字まで

　※0200から少しずつ対策を施してきましたが、ここからはセーブデータに関与する部分について修正を行います。
　　利用可能な文字数が規定よりも1つ減らされます。
　　今まで長い文字列が使われていた場合は注意してください。
　　最大文字数を越えるものは自動的に安全な文字数まで切り詰められるので、キャラ名が変わってしまったり
　　セーブデータ自体が壊れてしまう可能性があります。
　　セーブデータのバックアップを取った上で十分検討してください。

----------------------------------------
//0224 [2007/07/14] by Rayce

・ROメールの削除を失敗したとき「削除できませんでした」のメッセージが出力されないバグを修正（clif.c, intif.c）

・int_mail.cの全体的な修正と整形
　　-> 送信者名、受信者名、タイトルの末尾に \0 を強制する
　　-> mail_dataのアイテムソート用idがunsigned intになってなかったのを修正、%d → %u
　　-> mapif_parse_OpenMailBox() でメールがロードできなかったときは念のためmail_dataを
　　　 NULLで埋め尽くすようにしておく
　　-> TXT: mail_data用のfilenameがバッファオーバランしないようにサイズを変更、1024 → 1056
　　-> TXT: mail_dataを保存する際は lock_fopen(), lock_fclose() を利用する
　　-> SQL: mail_sql_store_mail() でbody_dataにわざわざデータを変換する無駄を省略
　　-> SQL: mail_sql_load() で必要のない `char_id` をSELECTしないように改善

----------------------------------------
//0223 [2007/07/14] by Rayce

・pet_delete() を呼び出すとき、card[1]ではなくcard[2]を参照していたためにペットデータが削除されなかった
　バグを修正（char.c, int_storage.c）

・キャラクターを削除するとき、ROメールに添付されたペットの卵情報が削除されずセーブデータにゴミが残り
　続ける問題を修正（int_mail.c）
・アイテムやZenyが添付されたままのROメールを削除できないように修正（int_mail.c）
	通常はクライアント側で判定が行われ、以下のメッセージが出力されるだけで0x254のパケットは送信されません。
	「削除しようとしているメールに受け取っていないアイテムが存在します。」
	しかしhacker対策としてinterサーバでも添付アイテムの存在をチェックするように強化します。

・TXT: mail_txt_deletemail() のmemcpy部分を少し改善（int_mail.c）

----------------------------------------
//0222 [2007/07/13] by Rayce

・clif.cの細かい整形
	-> clif_parse_ChangeDir() のセキュリティ対策
	-> clif_parse_HomActionRequest() から2005-05-09dRagexeに対するデコード処理部分を抹消
	-> webchat_message() のsprintfをsnprintfに修正
・動作に影響しないレベルの細かい整形（src/common, src/map）

----------------------------------------
//0221 [2007/07/13] by Rayce

・path.cから経路探索ルーチン単体テスト関数を抹消（path.c）
・intif.cの細かい整形
	-> intif_GMmessage() を少し変更
	-> intif_parse_GuildMemberInfoChanged() から不要な代入を削除
・guild.cの細かい整形
	-> db/castle_db.txtで指定できるMap_Name, Castle_Name, Event_Nameを23文字までに制限
	-> guild_broken() でメモリをアロケートしなくて済むように改善

----------------------------------------
//0220 [2007/07/12] by Rayce

・バッファオーバーラン対策として文字列の末尾に \0 を強制するように修正（core.c, httpd.c, socket.c）
・windows環境で吐き出されるcrashdump.logの改行コードをCR/LFに修正（core.c）
・httpd.cの細かい整形
	-> httpd_strcasencmp() の代わりにstrcasecmpを使う
	-> httpd_pages() 用の関数ポインタを HttpdFunc型 としてtypedefする
	-> rand() を atn_rand() に変更

----------------------------------------
//0219 [2007/07/12] by Rayce

・ROメールにアイテムやZenyを添付するとき、idxが不正な値の場合は弾くようにチェック強化（mail.c）
・mail_checkappend() をstaticに変更（mail.*）
・clif_parse_GuildRequestInfo() で先にtypeの不正チェックを行うように修正（clif.c）

・SC_INCMSP2によるMAXSP増加の計算タイミングを少し変更（status.c）
・status.cの動作に影響しないレベルの細かい整形

----------------------------------------
//0218 [2007/07/11] by Rayce

・0202におけるgetpetinfo関数およびgethomuninfo関数の変更点を巻き戻し
　これまでの修正によりペットとホムの名前には \0 が入ることが保証されたのでaStrdupを使う（script.c）
・setmapflag命令でnosaveを指定する際、MAP名を15文字までに制限（script.c）

・map_session_data構造体のメンバwarp_waitingをビットフィールドに変更（map.h, skill.c, unit.c）
・ranking.c, unit.cの細かい整形

----------------------------------------
//0217 [2007/07/11] by Rayce

・ペットの名前を23文字までに制限（pet.c）
・動作に影響しないレベルの細かい整形（chat.c, mob.c, party.c, pet.*）

----------------------------------------
//0216 [2007/07/11] by Rayce

・battle_auriga.confのpet_loot_typeが0のとき、ペットが過剰にアイテムをルートする際に
　重量が変化しなかったバグを修正（pet.c）
・倉庫を開いているときだけ以下のタイミングで storage_storage_save() を呼び出すように修正（clif.c, homun.c, pet.c）
	ホムの削除時
	ペットの卵の孵化時
	ペットを卵に戻す時
	battle_auriga.confのpet_leaveがyesのときでペットが親密度0で消える時
	battle_auriga.confのsave_player_when_drop_itemがyesのときでアイテムを床に落とした時

・mapif_create_pet() でペットの新規作成に失敗した場合にはfreeするように修正（int_pet.c）
・GCCにおいて map_getcellp() で警告が出ていたので修正（map.c）

----------------------------------------
//0215 [2007/07/10] by Rayce

・アクセス違反が発生する可能性を修正
	-> pet_select_egg() で不正なindexが送信されてくるのを防ぐ（pet.c）
	-> guild_created() でエンペリウムが見つからないときのチェックを考慮する（guild.c）
	-> db/skill_db.txtのinf2に8192のフラグがセットされているスキルについて、
	   スキルLvが11以上の場合にはスキルLv10と同じ消費アイテムチェック処理にする（skill.c）

・homun_callhom() でエンブリオを検索する際に pc_search_inventory() を使うように修正（homun.c）
・removecards_sub() の > を >= に修正（script.c）
・skill_weapon_refine() で pc_search_inventory() を二重に呼ばないように改善（skill.c）
・battle_skill_attack() のカイトの部分で「水晶のかけら」を検索する際、不必要な個数チェックを省略（battle.c）
・ポーションピッチャーおよびスリムポーションピッチャーをスキルLv11以上で使う場合、
　スキルLv10と同じアイテムを使用するように変更（skill.c）

・csv_data構造体へのキャストを明示してなかった箇所を修正（script.c）
・script.cの細かい整形

----------------------------------------
//0214 [2007/07/10] by Rayce

・ユーザー定義関数として使える関数名を49文字までに制限（npc.c）
・npc_parse_script(), npc_parse_function() を少しだけ改善（npc.c）
・skill.cで使う WARP_CLASS はnpc.hから取得するように変更（skill.c）
・npc.cの細かい整形

----------------------------------------
//0213 [2007/07/09] by Rayce

・mob.cの細かい整形（mob.*）
	-> イベントを持っているMobを倒したときバッファアンダーフローが起こる可能性を修正
	-> mob_ai_sub_hard() で攻撃されたかの確認を行う際、チェックが二重に行われる無駄を修正
	-> db/mob_db.txtで指定可能なモンスター名の文字数を23文字までに制限する
	-> db/mob_skill_db.txtにMOB_ID_MAXを越える値をIDとして指定した場合にサーバクラッシュするバグを修正
	-> db/mob_skill_db.txtにMAX_MOBSKILLを越える数のスキルを登録しても「readdb: too many skill」の警告が
	   出力されなかったバグを修正

----------------------------------------
//0212 [2007/07/08] by Rayce

・mail.cの細かい整形（mail.c）
	-> nullpoチェックを入れる
	-> ROメールの受信者およびタイトルの末尾に \0 を付加する

・map.cの細かい整形（map.c）
	-> block_free_max を BLOCK_FREE_MAX に改名
	-> BL_LIST_MAX はblock_list構造体用のtypeと混同するので BLOCK_LIST_MAX に改名
	-> map_calc_dir() の最適化
	-> MAP名の末尾に \0 を付加する

・sleep_data構造体を無名構造体に変更（script.h）
・以下の入れ子になった構造体を外に分離する（db.h, map.c, map.h, script.h）
	db_free
	map_cache_head
	pet_skill_attack
	pet_skill_support
	script_stack

----------------------------------------
//0211 [2007/07/08] by Rayce

・ランダム系アイテムデータベースを読み込む際、存在しないアイテムのIDが指定されていた場合は
　読み込み対象外にするように修正（itemdb.c）
・db/item_db.txtで指定可能なアイテムの日本語名および英語名を47文字までに拡張（itemdb.c）
	現時点で idnum2itemdisplaynametable.txt に記載されている最長のアイテム名が37文字でした。
	これらをカバーするため文字数制限を32文字から47文字に引き上げます。
	バッファオーバーラン対策により末尾には \0 を強要するため、48文字ではなく47文字です。
・@idsearchの処理を最適化（atcommand.c, itemdb.*）
	itemdb_idsearch() を追加。
	numdb_foreach() を使うので効率良く検索が行われます。
	itemdb.cにあった変数 max_itemid および itemdb_getmaxid() は不要になったので削除。
・@idsearchでスロット数を表示するように機能拡張（atcommand.c, msg_auriga.conf）
・itemdb.cの細かい整形

----------------------------------------
//0210 [2007/07/07] by Rayce

・lock.cでバッファオーバーランが発生する可能性を修正（lock.c）
・0208においてatcommand.cで警告が出ていたので修正
	-> 抜け落ちていたreturnを補完（atcommand.c）
	-> pc_setpos() の引数にconstを付ける（pc.*）

----------------------------------------
//0209 [2007/07/07] by Rayce

・ホムが消えるとき、泣きエモタイマーが即座に削除されないバグを修正（unit.c）
・HPが0のホムを召喚してしまった場合は unit_free() で削除するように修正（homun.c）
・homun_get_create_homunid() を簡素化（homun.c）
・ホムの名前を23文字に制限する（homun.c）
	バッファオーバーラン対策のため、db/homun_db.txtおよびリネーム時で使える文字数が
	24 → 23に変更されます
・動作に影響しないレベルの細かい整形（homun.*）

----------------------------------------
//0208 [2007/07/06] by Rayce

・battle_addmastery() でデーモンベインのダメージ加算計算に浮動小数演算を使わないように変更（battle.c）
・atcommand.cの全体的な整形
	不要なmemsetを撤廃
	@iconの第二引数省略時はONになるように拡張

----------------------------------------
//0207 [2007/07/06] by Rayce

・ペットの卵を倉庫に入れたとき装備品目に置かれなかった問題を修正（clif.c）
・unit_walktodir() を pc_runtodir() と同様に修正（unit.c）
・取引時の距離チェックは unit_distance2() を利用するように変更（trade.c）

・skill.cの全体的な細かい整形
・skill_check_condition2_pc() の「ソウルリンカーで使えないスキル」の部分をまとめ直し（skill.c）
	battle_config.soul_linker_battle_modeの使い方がおかしかったので修正
	battle_config.soul_linker_battle_mode_kaが何故か使われてなかったので修正

----------------------------------------
//0206 [2007/07/06] by Rayce

・サーバースナップショット（version.h）
・不要なファイルをフォルダごと削除
	./bin
	./script/mob
